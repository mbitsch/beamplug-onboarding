{% extends "base.html" %}

{% block title %}Trin 3 – WiFi{% endblock %}

{% block content %}
<div class="step">
    <div class="step-number">Trin 3 af 4</div>
    <h2>Vælg WiFi og indtast kode</h2>
    <p>Vi forbinder din BEAM-plug til WiFi, før du går videre til betaling.</p>

    <form method="post" action="{{ url_for('onboarding') }}" id="wifi-form">
        <!-- WiFi dropdown -->
        <label for="wifi_ssid_select">WiFi-navn (SSID)</label>
        <select id="wifi_ssid_select" required>
            <option value="" disabled selected>Vælg netværk</option>
            <option value="EDU">EDU</option>
            <option value="EDU-Guest">EDU-Guest</option>
            <option value="__other__">Andet netværk…</option>
        </select>

        <!-- “Andet netværk”-felt -->
        <input
            type="text"
            id="wifi_ssid_other"
            placeholder="Skriv WiFi-navn"
            style="display:none; margin-top: 8px;"
        />

        <!-- Skjult felt som Flask får (det er denne værdi, der ryger til backend) -->
        <input type="hidden" name="wifi_ssid" id="wifi_ssid_hidden" />

        <!-- Password -->
        <label for="wifi_password">WiFi-kode</label>
        <input type="password" name="wifi_password" id="wifi_password" required />

        <!-- Status-tekst (loader + godkendt) -->
        <div id="wifi-status" class="status-message" style="display:none;"></div>

        <!-- Hidden fields til flowet -->
        <input type="hidden" name="customer_id" value="{{ customer_id }}">
        <input type="hidden" name="radiator_setting" value="{{ radiator_setting }}">
        <input type="hidden" name="step" value="4" />

        <button type="submit" id="wifi-submit">Forbind og gå videre</button>
    </form>
</div>

<script>
    const selectEl = document.getElementById('wifi_ssid_select');
    const otherInput = document.getElementById('wifi_ssid_other');
    const hiddenSsid = document.getElementById('wifi_ssid_hidden');
    const form = document.getElementById('wifi-form');
    const statusEl = document.getElementById('wifi-status');
    const submitBtn = document.getElementById('wifi-submit');
    const wifiPassword = document.getElementById('wifi_password');

    function clearStatus() {
        statusEl.style.display = 'none';
        statusEl.textContent = '';
        statusEl.className = 'status-message';
    }

    function showStatus(type, message) {
        statusEl.style.display = 'inline-flex';
        statusEl.className = 'status-message status-message--' + type;
        statusEl.textContent = message;
    }

    // Skift mellem dropdown og "andet netværk"
    selectEl.addEventListener('change', () => {
        clearStatus();
        if (selectEl.value === '__other__') {
            otherInput.style.display = 'block';
            otherInput.required = true;
            hiddenSsid.value = '';
        } else {
            otherInput.style.display = 'none';
            otherInput.required = false;
            hiddenSsid.value = selectEl.value;
        }
    });

    // SUBMIT — loader i 5 sekunder og godkender
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        clearStatus();

        let ssidValue = hiddenSsid.value;
        if (selectEl.value === '__other__') {
            ssidValue = otherInput.value.trim();
        }

        if (!ssidValue) {
            showStatus('error', 'Vælg eller skriv et WiFi-navn.');
            return;
        }

        if (!wifiPassword.value) {
            showStatus('error', 'Indtast WiFi-koden.');
            return;
        }

        // Sæt værdi til backend
        hiddenSsid.value = ssidValue;

        // Start loading (5 sekunder)
        submitBtn.disabled = true;
        showStatus('loading', 'Forbinder til WiFi…');

        setTimeout(() => {
            // Efter 5 sekunder: godkendt
            showStatus('success', 'WiFi godkendt – går videre til næste trin ✔️');

            // Lille pause så brugeren når at se beskeden
            setTimeout(() => {
                form.submit();
            }, 800);

        }, 5000); // 5 sekunders loading
    });
</script>
{% endblock %}
